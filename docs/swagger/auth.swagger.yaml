openapi: 3.0.0
info:
  title: Authentication API
  version: v1
  description: API for user authentication and account management.

tags:
  - name: Auth
    description: API endpoints for user authentication and account management.

components:
  schemas:
    # Reusable Schema Definitions
    ID:
      type: string
      description: Unique identifier.
      example: "60d0fe4f5311236168a109ca"
      pattern: "^[0-9a-fA-F]{24}$"

    Email:
      type: string
      format: email
      description: Email address.
      example: "johndoe@example.com"
      maxLength: 255
      minLength: 5

    Password:
      type: string
      format: password
      description: User password. Must be at least 6 characters long.
      example: "SecurePass123"
      minLength: 6
      maxLength: 128

    FirstName:
      type: string
      description: First name of the user.
      example: "John"
      minLength: 2
      maxLength: 50

    LastName:
      type: string
      description: Last name of the user.
      example: "Doe"
      minLength: 2
      maxLength: 50

    PhoneNumber:
      type: string
      description: Phone number in international format.
      example: "+1234567890"
      pattern: "^\\+?[1-9]\\d{1,14}$"
      minLength: 10
      maxLength: 15

    Role:
      type: string
      enum: [admin, organization, educator]
      description: Role of the user (admin, organization, or educator).
      default: educator
      example: educator

    Token:
      type: string
      description: JWT token or verification token.
      example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

    User:
      type: object
      properties:
        _id:
          $ref: "#/components/schemas/ID"
        firstName:
          $ref: "#/components/schemas/FirstName"
        lastName:
          $ref: "#/components/schemas/LastName"
        email:
          $ref: "#/components/schemas/Email"
        phone:
          allOf:
            - $ref: "#/components/schemas/PhoneNumber"
          nullable: true
          description: Phone number (required for educators, optional for others).
        role:
          $ref: "#/components/schemas/Role"
        isEmailVerified:
          type: boolean
          description: Indicates if the user's email is verified.
          example: false
        isPhoneVerified:
          type: boolean
          description: Indicates if the user's phone number is verified.
          example: false
        createdAt:
          type: string
          format: date-time
          description: Timestamp of when the user account was created.
        updatedAt:
          type: string
          format: date-time
          description: Timestamp of when the user account was last updated.
      required:
        - firstName
        - lastName
        - email
        - role

    SignUpRequest:
      type: object
      required:
        - firstName
        - lastName
        - email
        - password
        - role
      properties:
        firstName:
          $ref: "#/components/schemas/FirstName"
        lastName:
          $ref: "#/components/schemas/LastName"
        email:
          $ref: "#/components/schemas/Email"
        phone:
          allOf:
            - $ref: "#/components/schemas/PhoneNumber"
          nullable: true
          description: Phone number (required for educators, optional for admin and organization roles).
        password:
          $ref: "#/components/schemas/Password"
        role:
          $ref: "#/components/schemas/Role"

    SignInRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          $ref: "#/components/schemas/Email"
        password:
          $ref: "#/components/schemas/Password"

    ForgotPasswordRequest:
      type: object
      required:
        - email
      properties:
        email:
          $ref: "#/components/schemas/Email"

    UpdatePasswordRequest:
      type: object
      required:
        - password
        - token
      properties:
        password:
          $ref: "#/components/schemas/Password"
        token:
          $ref: "#/components/schemas/Token"

    # Updated to match consistent service response structure
    ServiceResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Indicates if the operation was successful.
          example: true
        message:
          type: string
          description: Response message.
          example: "Operation completed successfully."
        data:
          description: Response data (varies by endpoint).

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
          description: Indicates the request was unsuccessful.
        message:
          type: string
          description: Error message.
          example: "An error occurred."

    # Updated SignIn response structure
    SignInData:
      type: object
      properties:
        id:
          $ref: "#/components/schemas/ID"
        name:
          type: string
          description: Full name of the user.
          example: "John Doe"
        email:
          $ref: "#/components/schemas/Email"
        role:
          $ref: "#/components/schemas/Role"
        token:
          $ref: "#/components/schemas/Token"

    SignInResponse:
      allOf:
        - $ref: "#/components/schemas/ServiceResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/SignInData"
          example:
            success: true
            message: "User signed in successfully"
            data:
              id: "60d0fe4f5311236168a109ca"
              name: "John Doe"
              email: "john.doe@example.com"
              role: "educator"

    SignUpResponse:
      allOf:
        - $ref: "#/components/schemas/ServiceResponse"
        - type: object
          example:
            success: true
            message: "User registered successfully. Please verify your email address."

    ForgotPasswordResponse:
      allOf:
        - $ref: "#/components/schemas/ServiceResponse"
        - type: object
          example:
            success: true
            message: "Reset password email sent successfully."

    UpdatePasswordResponse:
      allOf:
        - $ref: "#/components/schemas/ServiceResponse"
        - type: object
          example:
            success: true
            message: "Password updated successfully."

  responses:
    # Updated response definitions
    UserRegistered:
      description: User registered successfully.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SignUpResponse"

    SignInSuccess:
      description: User signed in successfully.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SignInResponse"

    PasswordResetEmailSent:
      description: Password reset email sent successfully.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ForgotPasswordResponse"

    PasswordUpdated:
      description: Password updated successfully.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/UpdatePasswordResponse"

    BadRequest:
      description: Bad request - validation error or missing parameters.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            validation_error:
              value:
                success: false
                message: "First name is required."
            user_exists:
              value:
                success: false
                message: "A user with this email already exists."
            phone_required:
              value:
                success: false
                message: "Phone number is required for educators."

    Unauthorized:
      description: Unauthorized - invalid credentials, unverified email, or missing token.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            invalid_credentials:
              value:
                success: false
                message: "Invalid email or password."
            email_not_verified:
              value:
                success: false
                message: "Email not verified. Please check your inbox."
            phone_not_verified:
              value:
                success: false
                message: "Phone number not verified. Educators must verify their phone numbers."
            invalid_token:
              value:
                success: false
                message: "Invalid or expired token"

    NotFound:
      description: Resource not found.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            user_not_found:
              value:
                success: false
                message: "User not found"
            endpoint_not_found:
              value:
                success: false
                message: "Endpoint not found"

    InternalServerError:
      description: Internal server error.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            token_generation_failed:
              value:
                success: false
                message: "Token generation failed."
            email_send_failed:
              value:
                success: false
                message: "Failed to send the welcome email."
            password_update_failed:
              value:
                success: false
                message: "Password update failed"
            internal_server_error:
              value:
                success: false
                message: "Internal Server Error"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

paths:
  /api/auth/signup:
    post:
      summary: Register a new user
      description: |
        Creates a new user account with the provided details.

        **Role-specific requirements:**
        - **Educators**: Phone number is required and must be verified after registration
        - **Admin/Organization**: Phone number is optional and will be ignored if provided

        **Verification Process:**
        - A verification email is sent to the provided email address
        - Users must verify their email before signing in
        - Educators must also verify their phone numbers

        **Response:**
        - Returns service response with success flag and message
        - No data object is returned for signup
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignUpRequest"
            examples:
              educator:
                summary: Educator registration
                value:
                  firstName: "John"
                  lastName: "Doe"
                  email: "john.doe@example.com"
                  phone: "+1234567890"
                  password: "SecurePass123"
                  role: "educator"
              admin:
                summary: Admin registration
                value:
                  firstName: "Jane"
                  lastName: "Smith"
                  email: "jane.smith@example.com"
                  password: "AdminPass456"
                  role: "admin"
      responses:
        201:
          $ref: "#/components/responses/UserRegistered"
        400:
          $ref: "#/components/responses/BadRequest"
        500:
          $ref: "#/components/responses/InternalServerError"

  /api/auth/signin:
    post:
      summary: Sign in a user
      description: |
        Authenticates the user using their credentials and returns user data with JWT token.

        **Prerequisites:**
        - Email must be verified
        - For educators: Phone number must also be verified

        **Response:**
        - JWT token is included in the response data and set as an HTTP-only cookie
        - User information is returned in the data object
        - Follows consistent service response structure with success, message, and data
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignInRequest"
            example:
              email: "john.doe@example.com"
              password: "SecurePass123"
      responses:
        200:
          $ref: "#/components/responses/SignInSuccess"
        401:
          $ref: "#/components/responses/Unauthorized"
        500:
          $ref: "#/components/responses/InternalServerError"

  /api/auth/forgot-password:
    post:
      summary: Request password reset
      description: |
        Initiates a password reset for the specified user.
        A password reset email with a secure token will be sent to the user's email address.

        **Response:**
        - Returns service response with success flag and message
        - No data object is returned for password reset request
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ForgotPasswordRequest"
            example:
              email: "john.doe@example.com"
      responses:
        200:
          $ref: "#/components/responses/PasswordResetEmailSent"
        404:
          $ref: "#/components/responses/NotFound"
        500:
          $ref: "#/components/responses/InternalServerError"

  /api/auth/update-password:
    patch:
      summary: Update password with reset token
      description: |
        Updates the user's password using a reset token received via email.
        The token is validated before allowing the password change.

        **Response:**
        - Returns service response with success flag and message
        - No data object is returned for password update
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdatePasswordRequest"
            example:
              token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
              password: "NewSecurePass789"
      responses:
        200:
          $ref: "#/components/responses/PasswordUpdated"
        400:
          $ref: "#/components/responses/BadRequest"
        404:
          $ref: "#/components/responses/NotFound"
        500:
          $ref: "#/components/responses/InternalServerError"
